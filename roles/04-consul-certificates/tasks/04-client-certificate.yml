---

- stat:
    path: "{{ certificate_root_dir }}/consul/client.pem.enc"
  register: "client_pem_enc"
- stat:
    path: "{{ certificate_root_dir }}/consul/client-key.pem.enc"
  register: "client_key_pem_enc"
- stat:
    path: "{{ certificate_root_dir }}/consul/client.csr.enc"
  register: "client_csr_enc"    
- block:
  - name : "removing leftover consul client 'client.pem.enc'"
    file: 
      path: "{{ certificate_root_dir }}/consul/client.pem.enc"
      state: absent
    when:
      - client_pem_enc.stat.exists
  - name : "removing leftover consul client 'client-key.pem.enc'"
    file: 
      path: "{{ certificate_root_dir }}/consul/client-key.pem.enc"
      state: absent
    when:
      - client_key_pem_enc.stat.exists
  - name : "removing leftover consul client 'client.csr.enc'"
    file: 
      path: "{{ certificate_root_dir }}/consul/client.csr.enc"
      state: absent
    when:
      - client_csr_enc.stat.exists
  - name: "Generating consul client certificate"
    shell: "echo '{}' | sudo cfssl gencert -ca={{ certificate_root_dir }}/consul/ca.pem -ca-key={{ certificate_root_dir }}/consul/ca-key.pem -config={{ cfssl_config_path }} -hostname='client.global.consul,{{ public_ips }},{{ private_ips }},localhost,127.0.0.1' - | cfssljson -bare client"
    args:
      chdir: "{{ certificate_root_dir }}/consul"
  when: >
    ca_pem_enc.stat.exists == False or
    ca_key_pem_enc.stat.exists == False or
    ca_csr_enc.stat.exists == False
  run_once: true
